name: ðŸ” Debug Deploy

on:
  push:
    branches: [ main ]

jobs:
  debug:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Debug SSH Connection
      run: |
        echo "ðŸ” Testing SSH connection and environment..."
        
        # Setup SSH
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.DROPLET_IP }} >> ~/.ssh/known_hosts
        
        # Basic SSH test and environment check
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ubuntu@${{ secrets.DROPLET_IP }} << 'EOF'
          echo "âœ… SSH connection successful"
          echo "ðŸ“ Current directory: $(pwd)"
          echo "ðŸ“ Home directory: $(ls -la ~)"
          
          echo "ðŸ” Checking for project directory..."
          if [ -d "clyvanta-new" ]; then
            echo "âœ… clyvanta-new directory exists"
            cd clyvanta-new
            echo "ðŸ“ Project directory contents: $(ls -la)"
            echo "ðŸ” Git status: $(git status --porcelain)"
          else
            echo "âŒ clyvanta-new directory not found"
            echo "ðŸ“ Available directories: $(ls -la)"
          fi
          
          echo "ðŸ³ Docker status:"
          docker --version || echo "âŒ Docker not found"
          docker ps || echo "âŒ Docker ps failed"
          
          echo "ðŸ” Docker Compose status:"
          docker compose version || echo "âŒ Docker Compose not found"
        EOF
        
        # Cleanup
        rm -f ~/.ssh/deploy_key
        echo "ðŸ” Debug complete"