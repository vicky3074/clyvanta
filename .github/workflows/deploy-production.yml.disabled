name: üöÄ Production Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production  # This ensures access to production environment secrets
    
    steps:
    - name: Deploy to Production
      run: |
        echo "üöÄ Starting production deployment..."
        
        # Setup SSH
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.DROPLET_IP }} >> ~/.ssh/known_hosts
        
        # Deploy to production
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ubuntu@${{ secrets.DROPLET_IP }} << 'EOF'
          echo "üì¶ Deploying to production server..."
          cd clyvanta-new || { echo "‚ùå Project directory not found"; exit 1; }
          
          echo "üìÑ Pulling latest code..."
          git pull origin main || { echo "‚ùå Git pull failed"; exit 1; }
          
          echo "üõë Stopping containers..."
          docker compose down || true
          
          echo "üöÄ Starting containers..."
          docker compose up -d --build
          
          echo "‚è≥ Waiting for startup..."
          sleep 15
          
          echo "üîç Health check..."
          if curl -f -s --max-time 10 http://localhost:8080 > /dev/null; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ùå Health check failed"
            docker ps
            exit 1
          fi
        EOF
        
        # Cleanup
        rm -f ~/.ssh/deploy_key
        echo "‚úÖ Production deployment complete"