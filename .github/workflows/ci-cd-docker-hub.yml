name: 🚀 CI/CD with Docker Hub

on:
  push:
    branches: [ main, staging ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Build and Push Docker Image
      run: |
        echo "🔨 Building Docker image for branch: ${{ github.ref_name }}"
        docker build -t vicky3074/clyvanta:${{ github.ref_name }} .
        echo "📤 Pushing to Docker Hub..."
        docker push vicky3074/clyvanta:${{ github.ref_name }}
        echo "✅ Successfully pushed vicky3074/clyvanta:${{ github.ref_name }}"
        
    - name: Deploy to Production
      if: github.ref == 'refs/heads/main'
      run: |
        echo "🚀 Deploying to production..."
        # Deploy using existing webhook system
        curl -f "http://159.203.61.237:4040/deploy?token=clyvanta-deploy-2025"
        echo "✅ Production deployment triggered"
        
    - name: Verify Deployment
      if: github.ref == 'refs/heads/main'
      run: |
        echo "🏥 Verifying deployment..."
        sleep 30
        
        # Test HTTP
        if curl -f -s http://159.203.61.237:8080 > /dev/null; then
          echo "✅ HTTP is working"
        else
          echo "❌ HTTP verification failed"
          exit 1
        fi
        
        # Test HTTPS (through Cloudflare)
        if curl -f -s https://clyvanta.com > /dev/null; then
          echo "✅ HTTPS is working"
        else
          echo "⚠️ HTTPS may still be propagating"
        fi
        
        echo "🌍 Deployment verification completed!"