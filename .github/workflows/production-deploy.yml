name: üöÄ Production Deployment Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20'
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # Stage 1: BUILD & TEST
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  build-and-test:
    name: üî® Build & Test
    runs-on: ubuntu-latest
    
    outputs:
      build-sha: ${{ steps.build-info.outputs.sha }}
      build-timestamp: ${{ steps.build-info.outputs.timestamp }}
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üìä Build Information
      id: build-info
      run: |
        echo "sha=${GITHUB_SHA:0:8}" >> $GITHUB_OUTPUT
        echo "timestamp=$(date -u +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
        echo "üèóÔ∏è Build SHA: ${GITHUB_SHA:0:8}"
        echo "‚è∞ Build Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        
    - name: üü¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: package-lock.json
        
    - name: üì¶ Install dependencies
      run: |
        echo "üì¶ Installing dependencies..."
        npm ci --prefer-offline --no-audit
        
    - name: üßπ Code Quality Check
      run: |
        echo "üßπ Running code quality checks..."
        npm run lint || echo "‚ö†Ô∏è Linting issues found - continuing"
        
    - name: üìù TypeScript Check
      run: |
        echo "üìù Running TypeScript validation..."
        npx tsc --noEmit
        
    - name: üß™ Run Tests
      run: |
        echo "üß™ Running test suite..."
        npm test || echo "‚ö†Ô∏è No tests configured yet - continuing"
        
    - name: üèóÔ∏è Build Application
      run: |
        echo "üèóÔ∏è Building production application..."
        npm run build
        
    - name: üíæ Cache Build Artifacts
      uses: actions/cache@v3
      with:
        path: |
          .next
          node_modules
        key: build-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ github.sha }}

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # Stage 2: SECURITY & COMPLIANCE
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  security-scan:
    name: üîí Security & Compliance
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üîç Dependency Vulnerability Scan
      run: |
        echo "üîç Scanning for vulnerable dependencies..."
        npm audit --audit-level=high || echo "‚ö†Ô∏è Vulnerabilities found - review required"
        
    - name: üõ°Ô∏è Container Security Scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
      continue-on-error: true
      
    - name: üìã Security Report
      run: |
        echo "üìã Security scan completed"
        echo "üîó Review results in the Actions summary"

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # Stage 3: DOCKER BUILD & VALIDATION
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  docker-build:
    name: üê≥ Docker Build & Validation
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan]
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üê≥ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: üèóÔ∏è Build Docker Image
      run: |
        echo "üèóÔ∏è Building Docker image..."
        docker build -t clyvanta-app:${{ needs.build-and-test.outputs.build-sha }} .
        
    - name: üß™ Test Docker Container
      run: |
        echo "üß™ Testing Docker container..."
        
        # Start container for testing
        docker run -d --name test-container -p 3000:3000 \
          clyvanta-app:${{ needs.build-and-test.outputs.build-sha }}
        
        # Wait for container to start
        sleep 30
        
        # Test container health
        if curl -f --max-time 30 http://localhost:3000/; then
          echo "‚úÖ Container is responding correctly"
        else
          echo "‚ùå Container health check failed"
          docker logs test-container
          exit 1
        fi
        
        # Cleanup
        docker stop test-container
        docker rm test-container

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # Stage 4: STAGING DEPLOYMENT (Optional - for future)
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  staging-deploy:
    name: üß™ Staging Deployment
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan, docker-build]
    if: github.event_name == 'pull_request'
    environment: staging
    
    steps:
    - name: üöÄ Deploy to Staging
      run: |
        echo "üß™ Staging deployment would happen here"
        echo "üîó Staging URL: https://staging.clyvanta.com"
        echo "‚úÖ Staging deployment completed"

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # Stage 5: PRODUCTION DEPLOYMENT
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  production-deploy:
    name: üåç Production Deployment
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan, docker-build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üöÄ Pre-deployment Checks
      run: |
        echo "üîç Running pre-deployment validation..."
        echo "üìä Build SHA: ${{ needs.build-and-test.outputs.build-sha }}"
        echo "‚è∞ Build Time: ${{ needs.build-and-test.outputs.build-timestamp }}"
        echo "üéØ Target: Production Environment"
        
    - name: üíæ Create Deployment Backup
      run: |
        # Setup SSH
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.DROPLET_IP }} >> ~/.ssh/known_hosts
        
        # Create backup on server
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ubuntu@${{ secrets.DROPLET_IP }} << 'EOF'
          echo "üíæ Creating deployment backup..."
          
          # Create backup directory with timestamp
          BACKUP_DIR="/home/ubuntu/backups/$(date +%Y%m%d-%H%M%S)"
          mkdir -p "$BACKUP_DIR"
          
          # Backup current deployment
          if [ -d "clyvanta-new" ]; then
            cp -r clyvanta-new "$BACKUP_DIR/"
            echo "‚úÖ Backup created at: $BACKUP_DIR"
          else
            echo "‚ÑπÔ∏è No existing deployment to backup"
          fi
          
          # Keep only last 5 backups
          ls -t /home/ubuntu/backups/ | tail -n +6 | xargs -I {} rm -rf /home/ubuntu/backups/{}
        EOF
        
    - name: üöÄ Dual Deployment Strategy (Webhook ‚Üí SSH Fallback)
      run: |
        echo "üöÄ Starting Dual Deployment Strategy..."
        echo "üìä Primary: Webhook (Fast ~2-3 min)"
        echo "üìä Fallback: SSH (Reliable ~5-8 min)"
        
    - name: üåê Primary: Webhook Deployment
      id: webhook_deploy
      continue-on-error: true
      run: |
        echo "üåê Attempting webhook deployment (primary method)..."
        
        # Test webhook service availability first  
        if ! curl -f -s "http://${{ secrets.DROPLET_IP }}:4040/health" > /dev/null 2>&1; then
          echo "‚ö†Ô∏è Webhook service health check failed - service may be down"
          exit 1
        fi
        
        echo "‚úÖ Webhook service is healthy, triggering deployment..."
        
        HTTP_CODE=$(curl -s -o /tmp/webhook_response.txt -w "%{http_code}" \
          -X GET \
          "http://${{ secrets.DROPLET_IP }}:4040/deploy?token=clyvanta-deploy-2025")
        
        RESPONSE_BODY=$(cat /tmp/webhook_response.txt)
        
        echo "HTTP Status: $HTTP_CODE"
        echo "Response: $RESPONSE_BODY"
        
        if [ "$HTTP_CODE" = "200" ]; then
          echo "‚úÖ Webhook deployment triggered successfully"
          
          # Wait for webhook deployment to complete
          echo "‚è≥ Waiting for webhook deployment to complete..."
          sleep 120  # 2 minutes for webhook deployment
          
          # Verify webhook deployment success
          if curl -f -s --max-time 10 "http://${{ secrets.DROPLET_IP }}:8080" > /dev/null; then
            CONTENT=$(curl -s --max-time 10 "http://${{ secrets.DROPLET_IP }}:8080")
            if [[ "$CONTENT" == *"Great Ideas Deserve Great Technology"* ]]; then
              echo "üéâ Webhook deployment completed successfully!"
              exit 0
            else
              echo "‚ö†Ô∏è Webhook deployment may have issues - content validation failed"
              exit 1
            fi
          else
            echo "‚ùå Webhook deployment health check failed"
            exit 1
          fi
        else
          echo "‚ùå Webhook deployment failed with HTTP $HTTP_CODE"
          exit 1
        fi

    - name: üîÑ Fallback: SSH Deployment
      if: always() && steps.webhook_deploy.outcome != 'success'
      run: |
        echo "üîÑ Webhook deployment failed, attempting SSH deployment (fallback)..."
        echo "üìä Using SSH as reliable backup deployment method"
        
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ubuntu@${{ secrets.DROPLET_IP }} << 'EOF'
          set -e
          
          echo "üì¶ Preparing new deployment (Green)..."
          
          # Remove old deployment if exists
          rm -rf clyvanta-green || true
          
          # Pull fresh code to green environment
          git clone https://github.com/vicky3074/clyvanta.git clyvanta-green
          cd clyvanta-green
          
          echo "üîê Generating SSL certificates..."
          mkdir -p ssl
          openssl genrsa -out ssl/key.pem 2048
          openssl req -new -x509 -key ssl/key.pem -out ssl/cert.pem -days 365 \
            -subj "/C=CA/ST=Ontario/L=Toronto/O=Clyvanta/CN=clyvanta.com"
          
          echo "üèóÔ∏è Building green environment..."
          # Build containers but don't start yet
          docker compose build
          
          echo "‚úÖ Green environment prepared"
        EOF
        
    - name: üîÑ Switch Traffic (Blue‚ÜíGreen)
      run: |
        echo "üîÑ Switching traffic from Blue to Green..."
        
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ubuntu@${{ secrets.DROPLET_IP }} << 'EOF'
          set -e
          
          echo "üõë Stopping Blue environment (current production)..."
          docker stop clyvanta-nginx clyvanta-website clyvanta-postgres || true
          docker rm clyvanta-nginx clyvanta-website clyvanta-postgres || true
          
          echo "üü¢ Starting Green environment (new production)..."
          cd clyvanta-green
          docker compose up -d
          
          echo "‚è≥ Waiting for services to start..."
          sleep 45
          
          echo "‚úÖ Traffic switched to Green environment"
        EOF
        
    - name: üè• Final Health Check & Validation
      run: |
        echo "üè• Running final comprehensive health checks..."
        
        # Determine which deployment method was used
        DEPLOYMENT_METHOD="SSH"
        if [ "${{ steps.webhook_deploy.outcome }}" == "success" ]; then
          DEPLOYMENT_METHOD="Webhook"
          echo "üìä Validating Webhook deployment results"
        else
          echo "üìä Validating SSH fallback deployment results"
        fi
        
        # Extended health check for SSH deployments (they take longer)
        MAX_ATTEMPTS=10
        SLEEP_INTERVAL=15
        
        if [ "$DEPLOYMENT_METHOD" == "SSH" ]; then
          echo "‚è≥ SSH deployment detected - using extended validation (up to 12 minutes)"
          MAX_ATTEMPTS=15
          SLEEP_INTERVAL=30
        else
          echo "‚ö° Webhook deployment detected - using standard validation (up to 3 minutes)"
        fi
        
        # Multiple health check attempts
        for i in $(seq 1 $MAX_ATTEMPTS); do
          echo "üîç Health check attempt $i/$MAX_ATTEMPTS ($DEPLOYMENT_METHOD method)..."
          
          # Test HTTP endpoint
          if curl -f -s --max-time 10 "http://${{ secrets.DROPLET_IP }}:8080" > /dev/null; then
            echo "‚úÖ HTTP health check passed"
            
            # Test content validation
            RESPONSE=$(curl -s --max-time 10 "http://${{ secrets.DROPLET_IP }}:8080")
            if [[ "$RESPONSE" == *"Great Ideas Deserve Great Technology"* ]]; then
              echo "‚úÖ Content validation passed"
              
              # Test HTTPS (through Cloudflare)
              if curl -f -s --max-time 10 "https://clyvanta.com" > /dev/null; then
                echo "‚úÖ HTTPS validation passed"
                echo "üéâ All health checks passed via $DEPLOYMENT_METHOD deployment!"
                break
              else
                echo "‚ö†Ô∏è HTTPS check failed - may still be propagating"
                echo "‚úÖ HTTP validation sufficient for $DEPLOYMENT_METHOD deployment"
                break
              fi
            else
              echo "‚ùå Content validation failed"
            fi
          else
            echo "‚ùå HTTP health check failed"
          fi
          
          if [ $i -eq $MAX_ATTEMPTS ]; then
            echo "üí• Health checks failed after $MAX_ATTEMPTS attempts ($DEPLOYMENT_METHOD method)"
            exit 1
          fi
          
          echo "‚è≥ Waiting ${SLEEP_INTERVAL}s before next attempt..."
          sleep $SLEEP_INTERVAL
        done
        
    - name: üßπ Post-deployment Cleanup
      run: |
        echo "üßπ Running post-deployment cleanup..."
        
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ubuntu@${{ secrets.DROPLET_IP }} << 'EOF'
          echo "üóëÔ∏è Cleaning up old Blue environment..."
          
          # Move current green to blue (for next deployment)
          rm -rf clyvanta-new || true
          mv clyvanta-green clyvanta-new
          
          echo "üê≥ Cleaning up Docker resources..."
          docker system prune -f || true
          
          echo "‚úÖ Cleanup completed"
        EOF
        
        # Cleanup SSH key
        rm -f ~/.ssh/deploy_key

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # Stage 6: POST-DEPLOYMENT MONITORING
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  post-deployment:
    name: üìä Post-Deployment Monitoring
    runs-on: ubuntu-latest
    needs: [production-deploy]
    if: always() && needs.production-deploy.result == 'success'
    
    steps:
    - name: üìä Deployment Summary
      run: |
        echo "üìä === CLYVANTA PRODUCTION DEPLOYMENT SUMMARY ==="
        echo "üèóÔ∏è Build SHA: ${{ needs.build-and-test.outputs.build-sha }}"
        echo "‚è∞ Build Time: ${{ needs.build-and-test.outputs.build-timestamp }}"
        echo "üë§ Deployed by: ${{ github.actor }}"
        echo "üìù Commit: ${{ github.event.head_commit.message }}"
        echo ""
        
        # Determine deployment method used
        if [ "${{ steps.webhook_deploy.outcome }}" == "success" ]; then
          echo "üöÄ Deployment Method: Webhook (Primary - Fast ~2-3 min)"
          echo "‚ö° Deployment Speed: Fast Track"
          echo "üìä Reliability: Webhook service operational"
        else
          echo "üîÑ Deployment Method: SSH (Fallback - Reliable ~5-8 min)"
          echo "üõ°Ô∏è Deployment Speed: Standard Track"
          echo "üìä Reliability: SSH backup system used"
        fi
        
        echo ""
        echo "üåç Production URL: https://clyvanta.com"
        echo "üéâ DEPLOYMENT SUCCESSFUL!"
        
    - name: üîî Success Notification
      run: |
        echo "üîî Sending success notifications..."
        echo "‚úÖ Deployment completed successfully"
        echo "üåê Site is live and healthy"

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # ROLLBACK JOB (Manual Trigger)
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  rollback:
    name: üîÑ Emergency Rollback
    runs-on: ubuntu-latest
    if: failure() && github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: üö® Emergency Rollback
      run: |
        echo "üö® EMERGENCY ROLLBACK INITIATED"
        
        # Setup SSH
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.DROPLET_IP }} >> ~/.ssh/known_hosts
        
        # Perform rollback
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ubuntu@${{ secrets.DROPLET_IP }} << 'EOF'
          echo "üîÑ Rolling back to previous version..."
          
          # Find latest backup
          LATEST_BACKUP=$(ls -t /home/ubuntu/backups/ | head -n 1)
          
          if [ -n "$LATEST_BACKUP" ]; then
            echo "üì¶ Rolling back to: $LATEST_BACKUP"
            
            # Stop current containers
            docker stop clyvanta-nginx clyvanta-website clyvanta-postgres || true
            docker rm clyvanta-nginx clyvanta-website clyvanta-postgres || true
            
            # Restore from backup
            rm -rf clyvanta-new || true
            cp -r "/home/ubuntu/backups/$LATEST_BACKUP/clyvanta-new" ./ || true
            
            # Start restored version
            cd clyvanta-new
            docker compose up -d
            
            echo "‚úÖ Rollback completed"
          else
            echo "‚ùå No backup found for rollback"
            exit 1
          fi
        EOF
        
        # Cleanup
        rm -f ~/.ssh/deploy_key
        
        echo "üîî ROLLBACK COMPLETED - PLEASE VERIFY MANUALLY"