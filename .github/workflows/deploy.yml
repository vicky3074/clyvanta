name: ğŸš€ Simple Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    environment: 
      name: production
      url: https://clyvanta.com
    steps:
      - name: ğŸš€ Deploy to production server
        run: |
          echo "ğŸš€ Starting deployment..."
          echo "ğŸ“Š Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          
          # SSH into production server and deploy
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > /tmp/ssh_key
          chmod 600 /tmp/ssh_key
          
          ssh -o StrictHostKeyChecking=no -i /tmp/ssh_key ubuntu@${{ secrets.DROPLET_IP }} << 'EOF'
            set -e
            cd clyvanta-new
            
            echo "ğŸ“¦ Creating backup..."
            docker tag clyvanta-website:latest clyvanta-website:backup-$(date +%Y%m%d-%H%M%S) 2>/dev/null || true
            docker tag clyvanta-nginx:latest clyvanta-nginx:backup-$(date +%Y%m%d-%H%M%S) 2>/dev/null || true
            
            echo "â¬‡ï¸ Pulling latest code..."
            git fetch origin
            git reset --hard origin/main
            
            echo "ğŸ”„ Building and deploying..."
            docker compose down
            docker compose up -d --build
            
            echo "â³ Waiting for containers..."
            sleep 30
            
            echo "ğŸ¥ Health check..."
            for i in {1..10}; do
              if curl -f http://localhost:8080 > /dev/null 2>&1; then
                echo "âœ… Health check passed!"
                break
              fi
              echo "â³ Attempt $i/10..."
              sleep 10
            done
            
            if ! curl -f http://localhost:8080 > /dev/null 2>&1; then
              echo "âŒ Health check failed! Rolling back..."
              docker compose down
              git reset --hard HEAD~1
              docker compose up -d --build
              exit 1
            fi
            
            echo "ğŸ‰ Deployment successful!"
          EOF

      - name: âœ… Verify deployment
        run: |
          echo "ğŸ” Final verification..."
          sleep 10
          
          if curl -f https://clyvanta.com > /dev/null 2>&1; then
            echo "âœ… Production site is live!"
            echo "ğŸ”— https://clyvanta.com"
          else
            echo "âŒ Site verification failed"
            exit 1
          fi

      - name: ğŸ§¹ Cleanup
        if: always()
        run: rm -f /tmp/ssh_key

      - name: ğŸ‰ Success notification
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸ”— Site: https://clyvanta.com"
          echo "ğŸ“Š Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Deployed by: ${{ github.actor }}"