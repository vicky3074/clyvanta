name: Test Environment Secrets

on:
  workflow_dispatch: # Manual trigger for testing

jobs:
  test-secrets:
    name: Test Production Environment
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Test Environment Secrets Access
      run: |
        echo "ðŸ§ª Testing environment secrets access..."
        
        # Check if secrets are available (without exposing values)
        if [ -n "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
          echo "âœ… SSH_PRIVATE_KEY secret is available"
        else
          echo "âŒ SSH_PRIVATE_KEY secret is missing"
          exit 1
        fi
        
        if [ -n "${{ secrets.DROPLET_IP }}" ]; then
          echo "âœ… DROPLET_IP secret is available"
        else
          echo "âŒ DROPLET_IP secret is missing"
          exit 1
        fi
        
        echo "ðŸŽ‰ All environment secrets are accessible!"

    - name: Test SSH Connection
      run: |
        echo "ðŸ”‘ Testing SSH connection to server..."
        
        # Setup SSH
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.DROPLET_IP }} >> ~/.ssh/known_hosts
        
        # Test SSH connection (just echo a message, don't change anything)
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ubuntu@${{ secrets.DROPLET_IP }} << 'EOF'
          echo "ðŸš€ SSH connection successful!"
          echo "Server: $(hostname)"
          echo "Date: $(date)"
          echo "Docker status: $(docker --version)"
        EOF
        
        # Cleanup
        rm -f ~/.ssh/deploy_key
        
        echo "âœ… SSH connection test completed successfully!"